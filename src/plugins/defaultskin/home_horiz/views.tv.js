define(["connectionManager","dom","globalize","./spotlight","imageLoader","focusManager","pluginManager","cardBuilder","./../skininfo","emby-itemscontainer"],function(connectionManager,dom,globalize,spotlight,imageLoader,focusManager,pluginManager,cardbuilder,skinInfo){"use strict";function fetchResumeItems(){var options={Limit:6,ParentId:this.parentId,ImageTypeLimit:1,EnableImageTypes:"Primary,Backdrop,Thumb"},apiClient=this.apiClient;return apiClient.getResumableItems(apiClient.getCurrentUserId(),options)}function getResumeItemsHtml(items){return cardbuilder.getCardsHtml({items:items,shape:"backdrop",rows:3,preferThumb:!0,scalable:!1})}function fetchLatestItems(){var options={IncludeItemTypes:"Episode",Limit:12,ParentId:this.parentId,EnableImageTypes:"Primary,Backdrop,Thumb",Fields:"PrimaryImageAspectRatio",ImageTypeLimit:1};return this.apiClient.getLatestItems(options)}function getLatestItemsHtml(items){return cardbuilder.getCardsHtml({items:items,shape:"backdrop",rows:3,preferThumb:!0,showGroupCount:!0})}function fetchNextUpItems(){var apiClient=this.apiClient,options={Fields:"PrimaryImageAspectRatio",ImageTypeLimit:1,Limit:18,ParentId:this.parentId,UserId:apiClient.getCurrentUserId(),EnableTotalRecordCount:!1};return apiClient.getNextUpEpisodes(options)}function getNextUpItemsHtml(items){return cardbuilder.getCardsHtml({items:items,shape:"backdrop",rows:3,preferThumb:!0})}function loadSpotlight(instance,element,apiClient,parentId){var options={SortBy:"Random",IncludeItemTypes:"Series",Limit:20,Recursive:!0,ParentId:parentId,EnableImageTypes:"Backdrop",ImageTypes:"Backdrop",Fields:"Taglines",ImageTypeLimit:1};return apiClient.getItems(apiClient.getCurrentUserId(),options).then(function(result){var card=element.querySelector(".wideSpotlightCard");instance.spotlight=new spotlight(card,result.Items,767)})}function backdropImageUrl(item,options){return options=options||{},options.type=options.type||"Backdrop",options.maxWidth||options.width||options.maxHeight||options.height||(options.quality=100),item.BackdropImageTags&&item.BackdropImageTags.length?(options.tag=item.BackdropImageTags[0],connectionManager.getApiClient(item.ServerId).getScaledImageUrl(item.Id,options)):null}function loadImages(element,apiClient,parentId){return apiClient.getItems(apiClient.getCurrentUserId(),{SortBy:"IsFavoriteOrLiked,Random",SortOrder:"Descending",IncludeItemTypes:"Series",Limit:3,Recursive:!0,ParentId:parentId,EnableImageTypes:"Backdrop",ImageTypes:"Backdrop",Fields:"PrimaryImageAspectRatio",ImageTypeLimit:1}).then(function(result){var items=result.Items,imgOptions={maxWidth:600};items.length>0&&(element.querySelector(".tvFavoritesCard .cardImage").style.backgroundImage="url('"+backdropImageUrl(items[0],imgOptions)+"')"),items.length>1&&(element.querySelector(".allSeriesCard .cardImage").style.backgroundImage="url('"+backdropImageUrl(items[1],imgOptions)+"')")})}function view(element,apiClient,parentId,autoFocus){var self=this;this.parentId=parentId,this.apiClient=apiClient,this.latestItemsContainer=element.querySelector(".latestSection .itemsContainer"),this.latestItemsContainer.fetchData=fetchLatestItems.bind(this),this.latestItemsContainer.getItemsHtml=getLatestItemsHtml.bind(this),this.latestItemsContainer.parentContainer=dom.parentWithClass(this.latestItemsContainer,"horizontalSection"),this.resumeItemsContainer=element.querySelector(".resumeSection .itemsContainer"),this.resumeItemsContainer.fetchData=fetchResumeItems.bind(this),this.resumeItemsContainer.getItemsHtml=getResumeItemsHtml.bind(this),this.resumeItemsContainer.parentContainer=dom.parentWithClass(this.resumeItemsContainer,"horizontalSection"),this.nextUpItemsContainer=element.querySelector(".nextUpSection .itemsContainer"),this.nextUpItemsContainer.fetchData=fetchNextUpItems.bind(this),this.nextUpItemsContainer.getItemsHtml=getNextUpItemsHtml.bind(this),this.nextUpItemsContainer.parentContainer=dom.parentWithClass(this.nextUpItemsContainer,"horizontalSection"),autoFocus&&focusManager.autoFocus(element),self.loadData=function(refresh){var promises=[this.resumeItemsContainer.resume({refresh:refresh}),this.nextUpItemsContainer.resume({refresh:refresh}),this.latestItemsContainer.resume({refresh:refresh})];return Promise.all(promises)},loadSpotlight(self,element,apiClient,parentId),loadImages(element,apiClient,parentId);var serverId=apiClient.serverId();element.querySelector(".allSeriesCard").addEventListener("click",function(){Emby.Page.show(pluginManager.mapRoute(skinInfo.id,"tv/tv.html?tab=0&parentId="+parentId+"&serverId="+serverId))}),element.querySelector(".tvUpcomingCard").addEventListener("click",function(){Emby.Page.show(pluginManager.mapRoute(skinInfo.id,"tv/tv.html?tab=2&parentId="+parentId+"&serverId="+serverId))}),element.querySelector(".tvFavoritesCard").addEventListener("click",function(){Emby.Page.show(pluginManager.mapRoute(skinInfo.id,"tv/tv.html?tab=3&parentId="+parentId+"&serverId="+serverId))}),self.onPause=function(){self.latestItemsContainer.pause(),self.resumeItemsContainer.pause(),self.nextUpItemsContainer.pause()},self.destroy=function(){self.spotlight&&(self.spotlight.destroy(),self.spotlight=null),self.latestItemsContainer=null,self.resumeItemsContainer=null,self.nextUpItemsContainer=null,self.apiClient=null}}return view});