define(["imageLoader","itemHelper","backdrop","mediaInfo","focusManager","scrollHelper","browser","layoutManager","dom","userSettings","connectionManager"],function(imageLoader,itemHelper,backdrop,mediaInfo,focusManager,scrollHelper,browser,layoutManager,dom,userSettings,connectionManager){"use strict";function fadeIn(elem){var keyframes=[{opacity:"0",offset:0},{opacity:"1",offset:1}],timing={duration:140,iterations:1,easing:"ease-out"};return elem.animate(keyframes,timing)}function focusHandler(options){function onFocusIn(e){var focused=e.target;if(focusedElement=focused,focused){if(selectedIndexElement){var index=focused.getAttribute("data-index");index&&(selectedIndexElement.innerHTML=1+parseInt(index))}if(layoutManager.tv)if(options.scroller){var now=(new Date).getTime(),animate=now-lastFocus>50;options.scroller.toCenter(focused,!animate),lastFocus=now}else options.scrollElement&&scrollHelper.toCenter(options.scrollElement,focused,isHorizontal);startSelectedInfoTimer()}}function onFocusOut(e){clearSelectedInfoTimer(),selectedItemInfoElement&&selectedItemInfoElementHasContent&&requestAnimationFrame(clearSelectedItemInfo);focusedElement=null}function clearSelectedInfoTimer(){selectedItemInfoTimeout&&clearTimeout(selectedItemInfoTimeout)}function startSelectedInfoTimer(){selectedItemInfoElement&&(clearSelectedInfoTimer(),selectedItemInfoTimeout=setTimeout(onSelectedInfoTimeout,500))}function onSelectedInfoTimeout(){var focused=focusedElement;focused&&setSelectedItemInfo(focused)}function getLogoImageUrl(item,options){return options=options||{},options.type="Logo",item.ImageTags&&item.ImageTags.Logo?(options.tag=item.ImageTags.Logo,connectionManager.getApiClient(item.ServerId).getScaledImageUrl(item.Id,options)):item.ParentLogoImageTag?(options.tag=item.ParentLogoImageTag,connectionManager.getApiClient(item.ServerId).getScaledImageUrl(item.ParentLogoItemId,options)):null}function setSelectedItemInfo(card){if(!1!==options.enableBackdrops||selectedItemInfoElement){var id=card.getAttribute("data-id");if(!id)return;var serverId=card.getAttribute("data-serverid"),apiClient=connectionManager.getApiClient(serverId);apiClient.getItem(apiClient.getCurrentUserId(),id).then(function(item){!1!==options.enableBackdrops&&userSettings.enableBackdrops()&&(browser.slow||browser.edge||backdrop.setBackdrop(item)),setSelectedInfo(card,item)})}}function setSelectedInfo(card,item){if(selectedItemInfoElement){var html="",logoImageUrl=getLogoImageUrl(item,{});logoImageUrl&&(html+='<div class="selectedItemInfoLogo" style="background-image:url(\''+logoImageUrl+"');\"></div>");var mediaInfoHtml="Program"===item.Type?mediaInfo.getSecondaryMediaInfoHtml(item):mediaInfo.getPrimaryMediaInfoHtml(item);html+='<div class="selectedItemInfoDetails">',html+='<div class="selectedItemName">',item.AlbumArtist&&(html+=item.AlbumArtist+" - "),item.IsSeries?html+=item.Name:html+=itemHelper.getDisplayName(item),html+="</div>",mediaInfoHtml&&(html+='<div class="selectedItemMediaInfo">',html+=mediaInfoHtml,html+="</div>"),html+="</div>",selectedItemInfoElement.innerHTML=html,selectedItemInfoElementHasContent=!0;var rect=card.getBoundingClientRect(),left=Math.min(rect.left,.8*dom.getWindowSize().innerWidth);selectedItemInfoElement.style.left=Math.max(left,70)+"px",html&&selectedItemInfoElement.animate&&fadeIn(selectedItemInfoElement,1)}}function clearSelectedItemInfo(){selectedItemInfoElement.innerHTML="",selectedItemInfoElementHasContent=!1}var focusedElement,self=this,parent=options.parent,isHorizontal=options.scroller?options.scroller.options.horizontal:options.horizontal,lastFocus=0;layoutManager.tv&&(dom.addEventListener(parent,"focus",onFocusIn,{capture:!0,passive:!0}),dom.addEventListener(parent,"blur",onFocusOut,{capture:!0,passive:!0}));var selectedItemInfoTimeout,selectedItemInfoElementHasContent,selectedItemInfoElement=options.selectedItemInfoElement,selectedIndexElement=options.selectedIndexElement;self.destroy=function(){dom.removeEventListener(parent,"focus",onFocusIn,{capture:!0,passive:!0}),dom.removeEventListener(parent,"blur",onFocusOut,{capture:!0,passive:!0}),selectedItemInfoElement&&(selectedItemInfoElement.innerHTML="")}}browser.animate||browser.edge;return focusHandler});